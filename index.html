<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Pardle</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

  <style>
    :root {
      --bg: #f5f5f5;
      --bg-card: #ffffff;
      --bg-card-elevated: #ffffff;
      --text: #111111;
      --text-muted: #666666;
      --accent: #ff9800;
      --accent-soft: rgba(255, 152, 0, 0.15);
      --accent-glow: rgba(255, 152, 0, 0.4);
      --border-soft: #e0e0e0;
      --sync-bg: #00c853;
      --sync-text: #ffffff;
      --green: #00c853;
      --green-soft: rgba(0, 200, 83, 0.15);
      --red: #ff3b30;
      --red-soft: rgba(255, 59, 48, 0.15);
      --yellow: #ffcc00;
      --gray: #6b7280;
      --input-bg: #ffffff;
      --input-text: #000000;
    }

    body[data-mode="dark"] {
      --bg: #101010;
      --bg-card: #1f1f1f;
      --bg-card-elevated: #2a2a2a;
      --text: #f5f5f5;
      --text-muted: #888888;
      --border-soft: #333333;
      --input-bg: #202020;
      --input-text: #ffffff;
      --accent-soft: rgba(255, 152, 0, 0.20);
      --green-soft: rgba(0, 200, 83, 0.20);
    }

    /* Accent invert: green primary, orange sync */
    body[data-accent="invert"] {
      --accent: #00c853;
      --accent-soft: rgba(0, 200, 83, 0.15);
      --accent-glow: rgba(0, 200, 83, 0.4);
      --sync-bg: #ff9800;
      --sync-text: #111111;
    }

    body[data-mode="dark"][data-accent="invert"] {
      --accent-soft: rgba(0, 200, 83, 0.20);
    }

    * {
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui, sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      min-height: 100dvh;
    }

    .app-shell {
      max-width: 480px;
      margin: 0 auto;
      min-height: 100vh;
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
      padding: 12px;
      padding-bottom: calc(80px + env(safe-area-inset-bottom));
      gap: 12px;
    }

    /* ================================
       TOAST NOTIFICATION SYSTEM
       ================================ */
    .toast-container {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 8px;
      pointer-events: none;
      max-width: 90%;
      width: 360px;
    }

    .toast {
      background: linear-gradient(135deg, #1f1f1f 0%, #2a2a2a 100%);
      border: 1px solid var(--sync-bg);
      border-radius: 14px;
      padding: 12px 16px;
      box-shadow: 0 8px 32px rgba(0, 200, 83, 0.3), 0 4px 12px rgba(0,0,0,0.4);
      display: flex;
      align-items: flex-start;
      gap: 10px;
      pointer-events: auto;
      cursor: pointer;
      animation: toastSlideIn 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .toast.hiding {
      animation: toastSlideOut 0.25s ease-in forwards;
    }

    @keyframes toastSlideIn {
      0% { opacity: 0; transform: translateY(-20px) scale(0.9); }
      100% { opacity: 1; transform: translateY(0) scale(1); }
    }

    @keyframes toastSlideOut {
      0% { opacity: 1; transform: translateY(0) scale(1); }
      100% { opacity: 0; transform: translateY(-10px) scale(0.95); }
    }

    .toast-icon { font-size: 20px; flex-shrink: 0; margin-top: 2px; }
    .toast-content { flex: 1; min-width: 0; }
    .toast-sender { font-size: 13px; font-weight: 700; color: var(--sync-bg); margin-bottom: 2px; }
    .toast-message { font-size: 13px; color: rgba(255,255,255,0.9); line-height: 1.3; }

    /* ================================
       START MODAL (Original Premium Style)
       ================================ */
    #startModal {
      --panel-top: #1b1b1e;
      --panel-bot: #0f0f12;
      --orange-0: #ffb000;
      --orange-1: #ff8c00;
      --orange-border: rgba(255, 159, 10, 0.26);
      --orange-border-hover: rgba(255, 159, 10, 0.55);
      --btn-dark-top: #2c2722;
      --btn-dark-bot: #1f1b18;
      --shadow-1: 0 28px 70px rgba(0,0,0,0.62);
      --shadow-2: 0 10px 26px rgba(0,0,0,0.45);
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      display: grid;
      place-items: center;
      background: radial-gradient(900px 600px at 50% 30%, rgba(255,159,10,0.06), transparent 60%),
                  linear-gradient(180deg, rgba(0,0,0,0.70), rgba(0,0,0,0.85));
      z-index: 100;
      transition: opacity 0.25s ease;
    }

    .modal-overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .start-modal {
      width: min(520px, calc(100vw - 48px));
      border-radius: 28px;
      background: linear-gradient(180deg, var(--panel-top), var(--panel-bot));
      box-shadow: var(--shadow-1);
      border: 1px solid rgba(255,255,255,0.08);
      position: relative;
      overflow: hidden;
      color: rgba(255,255,255,0.92);
    }

    .start-modal::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(120% 90% at 50% 10%, rgba(255,255,255,0.08), transparent 55%);
      pointer-events: none;
    }

    .start-inner {
      position: relative;
      padding: 44px 42px 40px;
    }

    .start-title {
      text-align: center;
      font-weight: 800;
      letter-spacing: 0.2px;
      font-size: clamp(40px, 6vw, 54px);
      margin: 0 0 6px;
      text-shadow: 0 6px 22px rgba(0,0,0,0.55);
    }

    .start-tagline {
      margin: -2px auto 20px;
      max-width: 34ch;
      text-align: center;
      font-size: 13px;
      line-height: 1.25;
      opacity: 0.85;
    }

    .menu-stack {
      display: grid;
      gap: 16px;
      justify-items: center;
    }

    .menu-btn {
      width: min(420px, 100%);
      height: 64px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-weight: 800;
      font-size: 26px;
      letter-spacing: 0.2px;
      display: grid;
      place-items: center;
      transition: transform 160ms ease, box-shadow 160ms ease, filter 160ms ease;
      box-shadow: var(--shadow-2);
    }

    .menu-btn:active { transform: translateY(1px); }

    .menu-btn.primary {
      color: rgba(255,255,255,0.95);
      background: linear-gradient(180deg, var(--orange-0), var(--orange-1));
      text-shadow: 0 2px 0 rgba(0,0,0,0.25);
      box-shadow: 0 14px 34px rgba(0,0,0,0.55);
    }

    .menu-btn.secondary {
      color: rgba(255,255,255,0.72);
      background: linear-gradient(180deg, var(--btn-dark-top), var(--btn-dark-bot));
      box-shadow: 0 12px 28px rgba(0,0,0,0.52), inset 0 0 0 1px var(--orange-border), inset 0 1px 0 rgba(255,255,255,0.08);
    }

    .menu-btn.secondary:disabled {
      opacity: 0.45;
      cursor: not-allowed;
    }

    .menu-btn.rules { height: 58px; font-size: 24px; }

    .menu-divider {
      width: min(420px, 100%);
      height: 1px;
      background: rgba(255,255,255,0.06);
      margin: 10px 0;
    }

    /* ================================
       HEADER
       ================================ */
    .app-header {
      background: var(--bg-card);
      padding: 10px 16px;
      border-radius: 14px;
      border: 1px solid var(--border-soft);
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .app-title {
      font-size: 20px;
      font-weight: 700;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .icon-btn {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      border: none;
      background: transparent;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.12s ease;
    }

    .icon-btn:active { transform: scale(0.95); opacity: 0.85; }

    .icon-btn-gear span { font-size: 33px; color: var(--sync-bg); }

    .icon-btn-analytics { gap: 2px; position: relative; top: 3px; }
    .icon-btn-analytics .bar { display: inline-block; width: 4px; border-radius: 999px; background: var(--sync-bg); }
    .icon-btn-analytics .bar.left { height: 10px; }
    .icon-btn-analytics .bar.middle { height: 16px; }
    .icon-btn-analytics .bar.right { height: 10px; }

    /* ================================
       CARDS
       ================================ */
    .card {
      background: var(--bg-card);
      border-radius: 14px;
      padding: 12px;
      border: 1px solid var(--border-soft);
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    }

    .card-elevated {
      background: linear-gradient(135deg, var(--bg-card-elevated) 0%, var(--bg-card) 100%);
    }

    .section-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    /* ================================
       GAME INFO BAR
       ================================ */
    .game-info {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .game-info-left { display: flex; flex-direction: column; gap: 2px; }
    .game-info-label { font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); }
    .game-info-value { font-size: 15px; font-weight: 600; }

    .game-id-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      background: var(--bg-card-elevated);
      border: 1px solid var(--border-soft);
      border-radius: 8px;
      font-size: 12px;
      font-family: monospace;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .game-id-pill:active { transform: scale(0.97); }

    .player-count { font-size: 12px; color: var(--text-muted); }

    /* ================================
       TODAY'S HOLE - HERO SECTION
       ================================ */
    .todays-hole {
      text-align: center;
      padding: 24px 16px;
    }

    .todays-hole-label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .todays-hole-number {
      font-size: 72px;
      font-weight: 800;
      color: var(--accent);
      line-height: 1;
      margin-bottom: 4px;
    }

    .todays-hole-of {
      font-size: 14px;
      color: var(--text-muted);
      margin-bottom: 24px;
    }

    .hole-stats {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 32px;
      margin-bottom: 28px;
    }

    .hole-stat { text-align: center; }
    .hole-stat-value { font-size: 28px; font-weight: 700; }
    .hole-stat-value.timer { color: var(--accent); font-variant-numeric: tabular-nums; }
    .hole-stat-label { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
    .hole-stat-divider { width: 1px; height: 40px; background: var(--border-soft); }

    /* ================================
       SCORE ENTRY
       ================================ */
    .score-entry { margin-top: 8px; }
    .score-entry-label { font-size: 13px; color: var(--text-muted); margin-bottom: 12px; }

    .score-buttons {
      display: flex;
      justify-content: center;
      gap: 6px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }

    .score-btn {
      width: 42px;
      height: 50px;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      background: var(--bg-card-elevated);
      color: var(--text);
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .score-btn:active { transform: scale(0.95); }

    .score-btn.selected {
      background: var(--accent);
      border-color: var(--accent);
      color: #000;
      transform: scale(1.08);
      box-shadow: 0 4px 20px var(--accent-glow);
    }

    .submit-btn {
      width: 100%;
      padding: 14px 24px;
      border-radius: 12px;
      border: none;
      background: var(--accent);
      color: #000;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .submit-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .submit-btn:not(:disabled):active { transform: scale(0.98); }

    .submitted-state {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px;
      background: var(--green-soft);
      border-radius: 12px;
      color: var(--green);
      font-weight: 600;
    }

    .submitted-state svg { width: 20px; height: 20px; }

    /* ================================
       LIVE STATUS
       ================================ */
    .live-status-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .live-status-title { font-size: 13px; font-weight: 600; color: var(--text-muted); }

    .live-indicator {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--green);
    }

    .live-dot {
      width: 6px;
      height: 6px;
      background: var(--green);
      border-radius: 50%;
      animation: pulse 1.5s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    .player-status-list { display: flex; flex-direction: column; gap: 8px; }

    .player-status-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      background: var(--bg-card-elevated);
      border-radius: 10px;
      border: 1px solid transparent;
    }

    .player-status-row.is-you {
      border-color: var(--accent);
      background: var(--accent-soft);
    }

    .player-status-left { display: flex; align-items: center; gap: 10px; }

    .player-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--border-soft);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      font-weight: 700;
      color: var(--text);
    }

    .player-avatar.is-you { background: var(--accent); color: #000; }

    .player-name { font-size: 14px; font-weight: 500; }
    .player-you-tag { font-size: 11px; color: var(--accent); margin-left: 4px; }

    .player-score-badge {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
    }

    .player-score-badge.eagle { background: var(--yellow); color: #000; }
    .player-score-badge.birdie { background: var(--green); color: #fff; }
    .player-score-badge.par { background: var(--gray); color: #fff; }
    .player-score-badge.bogey { background: #ff9800; color: #000; }
    .player-score-badge.double { background: var(--red); color: #fff; }

    .player-waiting {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .player-waiting svg { width: 14px; height: 14px; animation: spin 2s linear infinite; }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* ================================
       STANDINGS
       ================================ */
    .standings-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .standings-title { font-size: 13px; font-weight: 600; color: var(--text-muted); }
    .standings-subtitle { font-size: 11px; color: var(--text-muted); }

    .standings-list { display: flex; flex-direction: column; gap: 6px; }

    .standings-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid var(--border-soft);
    }

    .standings-row:last-child { border-bottom: none; }

    .standings-left { display: flex; align-items: center; gap: 10px; }

    .standings-position {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 700;
    }

    .standings-position.p1 { background: #fbbf24; color: #000; }
    .standings-position.p2 { background: #9ca3af; color: #000; }
    .standings-position.p3 { background: #cd7f32; color: #fff; }
    .standings-position.p4 { background: var(--border-soft); color: var(--text-muted); }

    .standings-name { font-size: 14px; }

    .standings-right { display: flex; align-items: center; gap: 12px; }
    .standings-total { font-size: 13px; color: var(--text-muted); }

    .standings-relative { font-size: 14px; font-weight: 700; min-width: 36px; text-align: right; }
    .standings-relative.under { color: var(--green); }
    .standings-relative.over { color: var(--red); }
    .standings-relative.even { color: var(--text-muted); }

    /* ================================
       PAST HOLES (COLLAPSIBLE)
       ================================ */
    .past-holes-toggle {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 0;
      background: none;
      border: none;
      cursor: pointer;
      color: var(--text-muted);
      font-size: 13px;
      font-weight: 600;
    }

    .past-holes-toggle svg { width: 18px; height: 18px; transition: transform 0.2s ease; }
    .past-holes.open .past-holes-toggle svg { transform: rotate(180deg); }

    .past-holes-content { display: none; padding-top: 8px; }
    .past-holes.open .past-holes-content { display: block; }

    .past-holes-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    .past-holes-table th,
    .past-holes-table td {
      padding: 8px 6px;
      text-align: center;
      border-bottom: 1px solid var(--border-soft);
    }

    .past-holes-table th { color: var(--text-muted); font-weight: 500; }

    .past-holes-table th:first-child,
    .past-holes-table td:first-child {
      text-align: left;
      position: sticky;
      left: 0;
      background: var(--bg-card);
    }

    .past-hole-score {
      display: inline-block;
      width: 24px;
      height: 24px;
      line-height: 24px;
      border-radius: 4px;
      font-weight: 600;
      font-size: 11px;
    }

    .past-hole-score.eagle { background: var(--yellow); color: #000; }
    .past-hole-score.birdie { background: var(--green); color: #fff; }
    .past-hole-score.par { background: var(--gray); color: #fff; }
    .past-hole-score.bogey { background: #ff9800; color: #000; }
    .past-hole-score.double { background: var(--red); color: #fff; }

    /* ================================
       CHAT FAB
       ================================ */
    .chat-fab {
      position: fixed;
      bottom: calc(24px + env(safe-area-inset-bottom));
      right: 24px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--accent);
      border: none;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease;
      z-index: 10;
    }

    .chat-fab.visible { display: flex; }
    .chat-fab:active { transform: scale(0.95); }
    .chat-fab svg { width: 24px; height: 24px; color: #000; }

    .chat-fab.has-unread {
      animation: chatPulseGlow 1.5s ease-in-out infinite;
      background: var(--sync-bg);
    }

    @keyframes chatPulseGlow {
      0%, 100% { box-shadow: 0 4px 20px rgba(0,0,0,0.3), 0 0 0 0 rgba(0, 200, 83, 0.6); }
      50% { box-shadow: 0 4px 20px rgba(0,0,0,0.3), 0 0 20px 4px rgba(0, 200, 83, 0.5); }
    }

    .chat-fab-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      min-width: 20px;
      height: 20px;
      padding: 0 6px;
      border-radius: 10px;
      background: var(--red);
      color: #fff;
      font-size: 11px;
      font-weight: 700;
      display: none;
      align-items: center;
      justify-content: center;
      border: 2px solid var(--bg);
      animation: badgeBounce 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .chat-fab-badge.visible { display: flex; }

    @keyframes badgeBounce {
      0% { transform: scale(0); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }

    /* ================================
       NO GAME STATE
       ================================ */
    .no-game-state {
      text-align: center;
      padding: 48px 24px;
    }

    .no-game-icon { font-size: 48px; margin-bottom: 16px; }
    .no-game-title { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
    .no-game-subtitle { font-size: 14px; color: var(--text-muted); margin-bottom: 24px; }

    .no-game-actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-width: 280px;
      margin: 0 auto;
    }

    .no-game-btn {
      padding: 14px 24px;
      border-radius: 12px;
      border: none;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .no-game-btn:active { transform: scale(0.98); }
    .no-game-btn.primary { background: var(--accent); color: #000; }
    .no-game-btn.secondary { background: var(--bg-card-elevated); color: var(--text); border: 1px solid var(--border-soft); }

    /* Round complete */
    .round-complete { text-align: center; padding: 32px 16px; }
    .round-complete-icon { font-size: 64px; margin-bottom: 16px; }
    .round-complete-title { font-size: 24px; font-weight: 700; margin-bottom: 8px; }
    .round-complete-subtitle { font-size: 14px; color: var(--text-muted); }

    /* Game content visibility */
    .game-content { display: none; }
    .game-content.visible { display: flex; flex-direction: column; gap: 12px; flex: 1; }

    /* ================================
       SHEETS
       ================================ */
    .sheet {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transition: opacity 0.2s ease, visibility 0.2s ease;
      z-index: 50;
    }

    .sheet.visible { opacity: 1; visibility: visible; pointer-events: auto; }

    .sheet-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.62);
      -webkit-backdrop-filter: blur(18px) saturate(140%);
      backdrop-filter: blur(18px) saturate(140%);
    }

    .sheet-inner {
      position: relative;
      z-index: 1;
      width: 100%;
      max-width: 480px;
      background: var(--bg-card);
      border-radius: 16px 16px 0 0;
      padding: 12px 16px;
      padding-bottom: calc(16px + env(safe-area-inset-bottom));
      max-height: 85vh;
      overflow-y: auto;
      border-top: 1px solid var(--border-soft);
    }

    .sheet-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 14px;
      font-weight: 700;
    }

    .sheet-close {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 1px solid var(--border-soft);
      background: rgba(0,0,0,0.04);
      color: var(--text);
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    body[data-mode="dark"] .sheet-close { background: rgba(255,255,255,0.06); }
    .sheet-close:active { transform: scale(0.96); opacity: 0.85; }

    .sheet-label { font-size: 14px; font-weight: 600; margin-bottom: 6px; display: block; }

    .sheet-input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      background: var(--input-bg);
      color: var(--input-text);
      font-size: 16px;
      margin-bottom: 12px;
    }

    .sheet-input:focus { outline: none; border-color: var(--accent); }

    .sheet-select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      background: var(--input-bg);
      color: var(--input-text);
      font-size: 16px;
      margin-bottom: 12px;
    }

    .sheet-actions { display: flex; gap: 8px; margin-top: 8px; }

    .sheet-btn {
      flex: 1;
      padding: 12px;
      border-radius: 10px;
      border: none;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .sheet-btn:active { transform: scale(0.98); }
    .sheet-btn.primary { background: var(--accent); color: #000; }
    .sheet-btn.secondary { background: var(--accent-soft); color: var(--text); }

    /* Chat specific */
    .chat-thread {
      max-height: 280px;
      overflow-y: auto;
      padding: 10px 12px;
      margin-bottom: 10px;
      border-radius: 12px;
      background: rgba(0,0,0,0.03);
      font-size: 13px;
    }

    body[data-mode="dark"] .chat-thread { background: rgba(255,255,255,0.04); }

    .chat-message {
      margin-bottom: 10px;
      display: flex;
      flex-direction: column;
      padding: 8px 10px;
      border-radius: 10px;
      background: rgba(0,0,0,0.03);
    }

    body[data-mode="dark"] .chat-message { background: rgba(255,255,255,0.05); }

    .chat-message.me { background: rgba(0, 200, 83, 0.12); margin-left: 20%; }
    .chat-message.me .meta { text-align: right; }
    .chat-message .meta { font-size: 11px; opacity: 0.7; margin-bottom: 3px; }
    .chat-message .text { font-size: 13px; line-height: 1.4; }

    .chat-input {
      width: 100%;
      min-height: 70px;
      border-radius: 12px;
      border: 1px solid var(--border-soft);
      padding: 10px 12px;
      font-size: 16px;
      margin-bottom: 10px;
      background: var(--input-bg);
      color: var(--input-text);
      resize: vertical;
    }

    /* Settings */
    .settings-section {
      margin-bottom: 14px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border-soft);
    }

    .settings-section:last-of-type { border-bottom: none; }

    .settings-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 0;
    }

    .settings-row-btn {
      width: 100%;
      border: none;
      background: transparent;
      text-align: left;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 0;
    }

    .settings-label { font-size: 13px; font-weight: 600; color: var(--text); }
    .settings-chevron { margin-left: auto; opacity: 0.6; font-size: 18px; }

    .theme-toggle {
      position: relative;
      display: inline-flex;
      margin-left: auto;
      flex-shrink: 0;
    }

    .theme-toggle input { opacity: 0; width: 0; height: 0; position: absolute; }

    .theme-toggle .slider {
      width: 40px;
      height: 20px;
      border-radius: 999px;
      background-color: #2a2a2a;
      position: relative;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .theme-toggle .slider::before {
      content: "";
      position: absolute;
      width: 16px;
      height: 16px;
      left: 2px;
      top: 2px;
      border-radius: 50%;
      background: #ffffff;
      transition: transform 0.2s ease;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
    }

    .theme-toggle input:checked + .slider { background-color: #6aaa64; }
    .theme-toggle input:checked + .slider::before { transform: translateX(20px); }

    /* Rules text */
    .rules-text { font-size: 13px; line-height: 1.5; }
    .rules-text h2 { margin-top: 6px; margin-bottom: 10px; font-size: 18px; }
    .rules-text h3 { margin-top: 14px; margin-bottom: 6px; color: var(--accent); font-size: 15px; }
    .rules-text p { margin: 6px 0; }
    .rules-text ul { margin: 6px 0 6px 20px; padding-left: 0; }
    .rules-text li { margin: 3px 0; }

    /* Analytics */
    .analytics-intro { font-size: 13px; line-height: 1.4; margin-bottom: 10px; }
    .analytics-list { display: flex; flex-direction: column; gap: 6px; font-size: 13px; }

    .analytics-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 10px;
      border-radius: 10px;
      background: rgba(0,0,0,0.03);
    }

    body[data-mode="dark"] .analytics-row { background: rgba(255,255,255,0.04); }

    .analytics-name { font-weight: 600; }
    .analytics-score { font-weight: 700; }

    /* Blur background when sheet open */
    body.sheet-open .app-header,
    body.sheet-open .app-content,
    body.sheet-open .game-content {
      filter: blur(10px);
      transform: scale(0.995);
      opacity: 0.98;
      pointer-events: none;
      transition: all 0.2s ease;
    }
  </style>
</head>
<body data-mode="dark" data-accent="normal">

  <!-- Toast container -->
  <div id="toastContainer" class="toast-container"></div>

  <!-- Start Modal -->
  <div id="startModal" class="modal-overlay">
    <div class="start-modal" role="dialog" aria-modal="true">
      <div class="start-inner">
        <div class="start-title">Pardle</div>
        <p class="start-tagline">Pardle is what happens when Wordle and golf have a beautiful, competitive baby.</p>
        <div class="menu-stack">
          <button id="startCreateBtn" class="menu-btn primary">Create Game</button>
          <button id="startRejoinBtn" class="menu-btn secondary" disabled>Rejoin Game</button>
          <button id="startJoinBtn" class="menu-btn secondary">Join Game</button>
          <div class="menu-divider"></div>
          <button id="startRulesBtn" class="menu-btn secondary rules">Game Rules</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Main App -->
  <div class="app-shell">
    <!-- Header -->
    <header class="app-header">
      <div class="app-title">Pardle</div>
      <div class="header-actions">
        <button id="analyticsBtn" class="icon-btn icon-btn-analytics" aria-label="Stats">
          <span class="bar left"></span>
          <span class="bar middle"></span>
          <span class="bar right"></span>
        </button>
        <button id="settingsBtn" class="icon-btn icon-btn-gear" aria-label="Settings">
          <span>‚öôÔ∏é</span>
        </button>
      </div>
    </header>

    <!-- No Game State -->
    <div id="noGameState" class="card no-game-state">
      <div class="no-game-icon">‚õ≥</div>
      <div class="no-game-title">No Active Game</div>
      <div class="no-game-subtitle">Create a new game or join an existing one to start playing.</div>
      <div class="no-game-actions">
        <button id="noGameCreateBtn" class="no-game-btn primary">Create Game</button>
        <button id="noGameJoinBtn" class="no-game-btn secondary">Join Game</button>
      </div>
    </div>

    <!-- Game Content -->
    <div id="gameContent" class="game-content">
      <!-- Game Info -->
      <div class="card game-info">
        <div class="game-info-left">
          <div class="game-info-label">Course</div>
          <div id="courseName" class="game-info-value">St. Androos Links</div>
        </div>
        <div>
          <button id="gameIdPill" class="game-id-pill">
            <span>‚ßâ</span>
            <span id="gameIdValue">loading...</span>
          </button>
          <div id="playerCount" class="player-count" style="margin-top:4px; text-align:right;">0 players</div>
        </div>
      </div>

      <!-- Today's Hole -->
      <div id="todaysHoleCard" class="card card-elevated todays-hole">
        <div class="todays-hole-label">Today's Hole</div>
        <div id="currentHoleNumber" class="todays-hole-number">1</div>
        <div id="holeProgress" class="todays-hole-of">of 18</div>

        <div class="hole-stats">
          <div class="hole-stat">
            <div id="currentPar" class="hole-stat-value">4</div>
            <div class="hole-stat-label">Par</div>
          </div>
          <div class="hole-stat-divider"></div>
          <div class="hole-stat">
            <div id="countdown" class="hole-stat-value timer">--:--</div>
            <div class="hole-stat-label">Time Left</div>
          </div>
        </div>

        <div id="scoreEntry" class="score-entry">
          <div class="score-entry-label">Enter your score</div>
          <div id="scoreButtons" class="score-buttons"></div>
          <button id="submitScoreBtn" class="submit-btn" disabled>Submit Score</button>
        </div>

        <div id="submittedState" class="submitted-state" style="display:none;">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
          </svg>
          <span>Score submitted!</span>
        </div>
      </div>

      <!-- Round Complete -->
      <div id="roundComplete" class="card round-complete" style="display:none;">
        <div class="round-complete-icon">üèÜ</div>
        <div class="round-complete-title">Round Complete!</div>
        <div class="round-complete-subtitle">All 18 holes finished. Check standings for final results.</div>
      </div>

      <!-- Live Status -->
      <div class="card">
        <div class="live-status-header">
          <span id="liveStatusTitle" class="live-status-title">Hole 1 Status</span>
          <span class="live-indicator">
            <span class="live-dot"></span>
            Live
          </span>
        </div>
        <div id="playerStatusList" class="player-status-list"></div>
      </div>

      <!-- Standings -->
      <div class="card">
        <div class="standings-header">
          <span class="standings-title">Standings</span>
          <span id="standingsSubtitle" class="standings-subtitle">After 0 holes</span>
        </div>
        <div id="standingsList" class="standings-list"></div>
      </div>

      <!-- Past Holes -->
      <div id="pastHolesSection" class="card past-holes" style="display:none;">
        <button id="pastHolesToggle" class="past-holes-toggle">
          <span>Past Holes</span>
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
          </svg>
        </button>
        <div class="past-holes-content">
          <div style="overflow-x:auto;">
            <table id="pastHolesTable" class="past-holes-table"></table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Chat FAB -->
  <button id="chatFab" class="chat-fab">
    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
    </svg>
    <span id="chatBadge" class="chat-fab-badge">0</span>
  </button>

  <!-- Chat Sheet -->
  <div id="chatSheet" class="sheet">
    <div class="sheet-backdrop"></div>
    <div class="sheet-inner">
      <div class="sheet-header">
        <span>Game Chat</span>
        <button id="chatCloseBtn" class="sheet-close">‚úï</button>
      </div>
      <div id="chatThread" class="chat-thread"></div>
      <textarea id="chatInput" class="chat-input" placeholder="Type your masterpiece‚Ä¶"></textarea>
      <div class="sheet-actions">
        <button id="chatCancelBtn" class="sheet-btn secondary">Cancel</button>
        <button id="chatSendBtn" class="sheet-btn primary">Send</button>
      </div>
    </div>
  </div>

  <!-- Settings Sheet -->
  <div id="settingsSheet" class="sheet">
    <div class="sheet-backdrop"></div>
    <div class="sheet-inner">
      <div class="sheet-header">
        <span>Settings</span>
        <button id="settingsCloseBtn" class="sheet-close">‚úï</button>
      </div>

      <div class="settings-section">
        <div class="settings-label">Appearance</div>
        <div class="settings-row">
          <span class="settings-label">Dark Theme</span>
          <label class="theme-toggle">
            <input type="checkbox" id="themeToggle" checked>
            <span class="slider"></span>
          </label>
        </div>
        <div class="settings-row">
          <span class="settings-label">Invert accents</span>
          <label class="theme-toggle">
            <input type="checkbox" id="accentToggle">
            <span class="slider"></span>
          </label>
        </div>
      </div>

      <div class="settings-section">
        <div class="settings-label">Help</div>
        <button id="settingsRulesBtn" class="settings-row-btn">
          <span class="settings-label">Game Rules</span>
          <span class="settings-chevron">‚Ä∫</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Rules Sheet -->
  <div id="rulesSheet" class="sheet">
    <div class="sheet-backdrop"></div>
    <div class="sheet-inner">
      <div class="sheet-header">
        <span>Game Rules</span>
        <button id="rulesCloseBtn" class="sheet-close">‚úï</button>
      </div>
      <div class="rules-text">
        <h2>PARDLE RULES</h2>
        <p>Pardle is what happens when Wordle and golf have a beautiful, competitive baby.</p>

        <h3>The Basics</h3>
        <ul>
          <li>Each "hole" is one Wordle puzzle.</li>
          <li>Your score for the hole equals the number of guesses it took you to solve that day's Wordle.</li>
          <li>Did not crack it? Mark it as a 7 (just make sure your group agrees).</li>
          <li>Par is the number of guesses you are aiming for.</li>
        </ul>

        <h3>Scoring</h3>
        <ul>
          <li>Your total score is the sum of guesses across all holes in the round.</li>
          <li>Relative score equals total score vs. par. Lower is better.</li>
          <li>Score breakdown:
            <ul>
              <li>"E" equals even with par</li>
              <li>"+2" equals two over par</li>
              <li>"-1" equals one under par</li>
            </ul>
          </li>
        </ul>

        <h3>Daily Play</h3>
        <ul>
          <li>One new hole unlocks each day at midnight.</li>
          <li>The countdown timer shows time remaining to submit today's score.</li>
          <li>A round is 18 holes, played over 18 days.</li>
          <li>Miss a day? You can still catch up by entering missed scores.</li>
        </ul>

        <h3>Not sure which button to tap?</h3>
        <p><strong>Create Game</strong><br>
          Use this if you are setting up a new match. You'll get a code to share with friends.
        </p>
        <p><strong>Rejoin Game</strong><br>
          Use this to return to a game you were already playing on this device.
        </p>
        <p><strong>Join Game</strong><br>
          Use this if someone sent you a game code. Enter the code and you're in.
        </p>

        <p style="margin-top:16px;">Pardle is perfect for tracking daily scores with your crew, flexing your vocab game, and delivering top tier trash talk.</p>
      </div>
    </div>
  </div>

  <!-- Analytics Sheet -->
  <div id="analyticsSheet" class="sheet">
    <div class="sheet-backdrop"></div>
    <div class="sheet-inner">
      <div class="sheet-header">
        <span>Round Stats</span>
        <button id="analyticsCloseBtn" class="sheet-close">‚úï</button>
      </div>
      <p class="analytics-intro">Pardle handicap and deeper analytics are coming soon. For now, here's a quick summary of this round.</p>
      <div id="analyticsContent" class="analytics-list"></div>
    </div>
  </div>

  <!-- Create Game Sheet -->
  <div id="createSheet" class="sheet">
    <div class="sheet-backdrop"></div>
    <div class="sheet-inner">
      <div class="sheet-header">
        <span>Create Game</span>
        <button id="createCloseBtn" class="sheet-close">‚úï</button>
      </div>
      <div class="section-title">Your Name</div>
      <input id="createNameInput" class="sheet-input" placeholder="Enter your name" autocomplete="name">
      <div class="section-title">Course</div>
      <select id="createCourseSelect" class="sheet-select">
        <option value="st-andrews">St. Androos Links</option>
        <option value="augusta">Azalea National</option>
        <option value="bully-pulpit">Badlands Pulpit</option>
        <option value="torrey-pines">Torrey Pints</option>
        <option value="bethpage-black">Bethpage Back Tees</option>
        <option value="sweetwater">Sweetwater Country Klub</option>
        <option value="tpc-sawgrass">TPC Strawgrass</option>
        <option value="whistling-straits">Whistling Straights</option>
        <option value="pebble-beach">Pebble Reach</option>
        <option value="congressional">Congress-ish National</option>
      </select>
      <p style="font-size:12px; color:var(--text-muted); margin-bottom:12px;">You'll get a code to share with your group.</p>
      <div class="sheet-actions">
        <button id="createCancelBtn" class="sheet-btn secondary">Cancel</button>
        <button id="createConfirmBtn" class="sheet-btn primary">Create</button>
      </div>
    </div>
  </div>

  <!-- Join Game Sheet -->
  <div id="joinSheet" class="sheet">
    <div class="sheet-backdrop"></div>
    <div class="sheet-inner">
      <div class="sheet-header">
        <span>Join Game</span>
        <button id="joinCloseBtn" class="sheet-close">‚úï</button>
      </div>
      <div class="section-title">Your Name</div>
      <input id="joinNameInput" class="sheet-input" placeholder="Enter your name" autocomplete="name">
      <div class="section-title">Game Code</div>
      <input id="joinCodeInput" class="sheet-input" placeholder="Paste the code" autocapitalize="none">
      <div class="sheet-actions">
        <button id="joinCancelBtn" class="sheet-btn secondary">Cancel</button>
        <button id="joinConfirmBtn" class="sheet-btn primary">Join</button>
      </div>
    </div>
  </div>

  <!-- Invite Sheet -->
  <div id="inviteSheet" class="sheet">
    <div class="sheet-backdrop"></div>
    <div class="sheet-inner">
      <div class="sheet-header">
        <span>Invite your crew</span>
        <button id="inviteCloseBtn" class="sheet-close">‚úï</button>
      </div>
      <p style="font-size:13px; margin-bottom:8px;"><strong>Share this code</strong></p>
      <p style="font-size:12px; color:var(--text-muted); margin-bottom:12px;">Your friends tap Join Game and enter it.</p>
      <button id="inviteCodePill" class="game-id-pill" style="width:100%; justify-content:center; padding:14px; font-size:16px; margin-bottom:16px;">
        <span>‚ßâ</span>
        <span id="inviteCodeValue">loading...</span>
      </button>
      <p style="font-size:12px; color:var(--text-muted); margin-bottom:12px;">Pro move: use Share to open Messages or Mail with the code prefilled.</p>
      <div class="sheet-actions">
        <button id="inviteCopyBtn" class="sheet-btn secondary">Copy</button>
        <button id="inviteShareBtn" class="sheet-btn primary">Share</button>
      </div>
      <button id="inviteDoneBtn" class="sheet-btn secondary" style="width:100%; margin-top:10px;">Done</button>
    </div>
  </div>

  <script>
    // ==============================
    // Firebase setup
    // ==============================
    const firebaseConfig = {
      apiKey: "AIzaSyDxmmTSpvM1xvVRb8qiOQfbbQWHSJEgIrk",
      authDomain: "pardle-online.firebaseapp.com",
      projectId: "pardle-online",
      storageBucket: "pardle-online.firebasestorage.app",
      messagingSenderId: "552026596516",
      appId: "1:552026596516:web:779d08f94ef455eda7f231"
    };

    let db = null;
    try {
      firebase.initializeApp(firebaseConfig);
      db = firebase.firestore();
      firebase.auth().signInAnonymously().catch(e => console.error("Auth error:", e));
    } catch (e) {
      console.error("Firebase init error:", e);
    }

    // ==============================
    // Constants
    // ==============================
    const STORAGE_PLAYER_ID = "pardle_player_id";
    const STORAGE_GAME_ID = "pardle_game_id";
    const STORAGE_SLOT = "pardle_slot";
    const STORAGE_MODE = "pardle_mode";
    const STORAGE_ACCENT = "pardle_accent";
    const STORAGE_LAST_SEEN = "pardle_last_seen_msg";

    const COURSES = {
      "st-andrews": { name: "St. Androos Links", pars: [4,4,4,4,5,4,4,3,4,4,3,4,4,5,4,4,4,4] },
      "augusta": { name: "Azalea National", pars: [4,5,4,3,4,3,4,5,4,4,4,3,5,4,5,3,4,4] },
      "bully-pulpit": { name: "Badlands Pulpit", pars: [4,4,4,5,5,3,4,3,4,4,5,3,4,4,3,4,5,4] },
      "torrey-pines": { name: "Torrey Pints", pars: [4,4,3,4,5,4,4,3,5,5,4,3,4,4,3,4,5,4] },
      "bethpage-black": { name: "Bethpage Back Tees", pars: [4,4,3,5,4,4,5,3,4,4,4,4,5,3,4,4,3,4] },
      "sweetwater": { name: "Sweetwater Country Klub", pars: [4,4,3,4,5,3,4,4,3,4,4,3,4,5,3,4,4,3] },
      "tpc-sawgrass": { name: "TPC Strawgrass", pars: [4,5,3,4,4,4,4,3,5,4,5,4,3,4,4,5,3,4] },
      "whistling-straits": { name: "Whistling Straights", pars: [4,5,3,4,5,4,3,4,4,4,5,3,4,4,4,5,3,4] },
      "pebble-beach": { name: "Pebble Reach", pars: [4,5,4,4,3,5,3,4,4,4,4,3,4,5,4,4,3,5] },
      "congressional": { name: "Congress-ish National", pars: [4,3,4,5,4,5,3,4,5,3,5,4,3,4,5,5,4,4] }
    };

    const HOLES = 18;
    const MAX_PLAYERS = 4;

    // ==============================
    // State
    // ==============================
    let currentGameId = null;
    let currentPlayerId = null;
    let currentPlayerSlot = null;
    let currentGameData = null;
    let unsubGame = null;
    let unsubMessages = null;
    let selectedScore = null;
    let unreadCount = 0;
    let countdownInterval = null;
    let messagesInitialized = false;

    // ==============================
    // DOM refs
    // ==============================
    const $ = id => document.getElementById(id);
    const body = document.body;

    // ==============================
    // Helpers
    // ==============================
    function generateId(len = 20) {
      const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
      return Array.from({ length: len }, () => chars[Math.floor(Math.random() * chars.length)]).join("");
    }

    function getPlayerId() {
      let id = localStorage.getItem(STORAGE_PLAYER_ID);
      if (!id) { id = generateId(16); localStorage.setItem(STORAGE_PLAYER_ID, id); }
      return id;
    }

    function hasSavedGame() { return !!localStorage.getItem(STORAGE_GAME_ID); }

    function getCurrentHole(gameData) {
      if (!gameData || !gameData.startedAt) return 1;
      const startDate = gameData.startedAt.toDate ? gameData.startedAt.toDate() : new Date(gameData.startedAt);
      const now = new Date();
      const startDay = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const daysDiff = Math.floor((today - startDay) / (1000 * 60 * 60 * 24));
      return Math.min(Math.max(1, daysDiff + 1), HOLES);
    }

    function getTimeUntilMidnight() {
      const now = new Date();
      const midnight = new Date(now);
      midnight.setHours(24, 0, 0, 0);
      return midnight - now;
    }

    function formatCountdown(ms) {
      if (ms <= 0) return "00:00";
      const hours = Math.floor(ms / (1000 * 60 * 60));
      const mins = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
      const secs = Math.floor((ms % (1000 * 60)) / 1000);
      if (hours > 0) return `${hours}:${String(mins).padStart(2, "0")}`;
      return `${mins}:${String(secs).padStart(2, "0")}`;
    }

    function startCountdown() {
      if (countdownInterval) clearInterval(countdownInterval);
      const updateTimer = () => { $("countdown").textContent = formatCountdown(getTimeUntilMidnight()); };
      updateTimer();
      countdownInterval = setInterval(updateTimer, 1000);
    }

    function getScoreClass(score, par) {
      if (!score || !par) return "";
      const diff = score - par;
      if (diff <= -2) return "eagle";
      if (diff === -1) return "birdie";
      if (diff === 0) return "par";
      if (diff === 1) return "bogey";
      return "double";
    }

    function getScoreLabel(score, par) {
      if (!score || !par) return "";
      const diff = score - par;
      if (diff <= -2) return "Eagle";
      if (diff === -1) return "Birdie";
      if (diff === 0) return "Par";
      if (diff === 1) return "Bogey";
      return "Double+";
    }

    function getRelativeScore(totalScore, totalPar) {
      if (!totalScore || !totalPar) return { text: "E", class: "even" };
      const diff = totalScore - totalPar;
      if (diff === 0) return { text: "E", class: "even" };
      if (diff > 0) return { text: "+" + diff, class: "over" };
      return { text: String(diff), class: "under" };
    }

    function escapeHtml(text) {
      const div = document.createElement("div");
      div.textContent = text;
      return div.innerHTML;
    }

    // ==============================
    // Toast
    // ==============================
    function showToast(sender, message, onClick) {
      const container = $("toastContainer");
      const toast = document.createElement("div");
      toast.className = "toast";
      toast.innerHTML = `
        <span class="toast-icon">üí¨</span>
        <div class="toast-content">
          <div class="toast-sender">${escapeHtml(sender)}</div>
          <div class="toast-message">${escapeHtml(message)}</div>
        </div>
      `;
      toast.onclick = () => {
        toast.classList.add("hiding");
        setTimeout(() => toast.remove(), 200);
        if (onClick) onClick();
      };
      container.appendChild(toast);
      if (navigator.vibrate) navigator.vibrate(50);
      setTimeout(() => {
        if (toast.parentNode) {
          toast.classList.add("hiding");
          setTimeout(() => toast.remove(), 200);
        }
      }, 4000);
    }

    // ==============================
    // Sheet helpers
    // ==============================
    function openSheet(id) {
      const sheet = $(id);
      if (sheet) { sheet.classList.add("visible"); body.classList.add("sheet-open"); }
    }

    function closeSheet(id) {
      const sheet = $(id);
      if (sheet) { sheet.classList.remove("visible"); }
      if (!document.querySelector(".sheet.visible")) body.classList.remove("sheet-open");
    }

    function setupSheetBackdrop(sheetId, closeFn) {
      const sheet = $(sheetId);
      if (!sheet) return;
      const handler = e => {
        if (e.target === sheet || e.target.classList.contains("sheet-backdrop")) closeFn();
      };
      sheet.addEventListener("click", handler);
      sheet.addEventListener("touchstart", handler, { passive: true });
    }

    // ==============================
    // UI Updates
    // ==============================
    function showGameUI() {
      $("startModal").classList.add("hidden");
      $("noGameState").style.display = "none";
      $("gameContent").classList.add("visible");
      $("chatFab").classList.add("visible");
    }

    function showNoGameUI() {
      $("startModal").classList.add("hidden");
      $("noGameState").style.display = "block";
      $("gameContent").classList.remove("visible");
      $("chatFab").classList.remove("visible");
    }

    function updateStartButtons() {
      const saved = hasSavedGame();
      $("startRejoinBtn").disabled = !saved;
      $("startRejoinBtn").style.opacity = saved ? "1" : "0.45";
    }

    function renderScoreButtons() {
      const container = $("scoreButtons");
      container.innerHTML = "";
      for (let i = 1; i <= 7; i++) {
        const btn = document.createElement("button");
        btn.className = "score-btn";
        btn.textContent = i;
        btn.dataset.score = i;
        btn.onclick = () => selectScore(i);
        container.appendChild(btn);
      }
    }

    function selectScore(score) {
      selectedScore = score;
      document.querySelectorAll(".score-btn").forEach(btn => {
        btn.classList.toggle("selected", parseInt(btn.dataset.score) === score);
      });
      $("submitScoreBtn").disabled = false;
    }

    function renderGame(data) {
      if (!data) return;
      currentGameData = data;

      const course = COURSES[data.courseId] || COURSES["st-andrews"];
      const currentHole = getCurrentHole(data);
      const players = data.players || [];
      const pars = course.pars;

      $("courseName").textContent = course.name;
      $("gameIdValue").textContent = currentGameId.slice(0, 12) + "...";
      $("playerCount").textContent = players.filter(p => p && p.id).length + " players";

      const roundComplete = currentHole > HOLES;

      if (roundComplete) {
        $("todaysHoleCard").style.display = "none";
        $("roundComplete").style.display = "block";
        $("liveStatusTitle").textContent = "Final Results";
      } else {
        $("todaysHoleCard").style.display = "block";
        $("roundComplete").style.display = "none";
        $("currentHoleNumber").textContent = currentHole;
        $("holeProgress").textContent = `of ${HOLES}`;
        $("currentPar").textContent = pars[currentHole - 1];
        $("liveStatusTitle").textContent = `Hole ${currentHole} Status`;

        const myPlayer = players[currentPlayerSlot];
        const myScores = myPlayer?.scores || [];
        const hasSubmitted = myScores[currentHole - 1] != null;

        if (hasSubmitted) {
          $("scoreEntry").style.display = "none";
          $("submittedState").style.display = "flex";
        } else {
          $("scoreEntry").style.display = "block";
          $("submittedState").style.display = "none";
          selectedScore = null;
          document.querySelectorAll(".score-btn").forEach(btn => btn.classList.remove("selected"));
          $("submitScoreBtn").disabled = true;
        }
      }

      // Live status
      const statusList = $("playerStatusList");
      statusList.innerHTML = "";
      players.forEach((player, idx) => {
        if (!player || !player.id) return;
        const scores = player.scores || [];
        const holeScore = roundComplete ? null : scores[currentHole - 1];
        const isYou = idx === currentPlayerSlot;
        const par = roundComplete ? 0 : pars[currentHole - 1];

        const row = document.createElement("div");
        row.className = "player-status-row" + (isYou ? " is-you" : "");

        const scoreHtml = holeScore != null
          ? `<span class="player-score-badge ${getScoreClass(holeScore, par)}">${holeScore} (${getScoreLabel(holeScore, par)})</span>`
          : `<span class="player-waiting"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>Waiting...</span>`;

        row.innerHTML = `
          <div class="player-status-left">
            <div class="player-avatar${isYou ? " is-you" : ""}">${(player.name || "?")[0].toUpperCase()}</div>
            <span class="player-name">${player.name || "Player " + (idx + 1)}${isYou ? '<span class="player-you-tag">(you)</span>' : ""}</span>
          </div>
          ${!roundComplete ? scoreHtml : ""}
        `;
        statusList.appendChild(row);
      });

      // Standings
      const completedHoles = Math.min(currentHole - 1, HOLES);
      $("standingsSubtitle").textContent = `After ${completedHoles} hole${completedHoles !== 1 ? "s" : ""}`;

      const standings = players
        .map((p, idx) => {
          if (!p || !p.id) return null;
          const scores = p.scores || [];
          let total = 0, parTotal = 0;
          for (let h = 0; h < completedHoles; h++) {
            if (scores[h] != null) { total += scores[h]; parTotal += pars[h]; }
          }
          return { name: p.name || "Player " + (idx + 1), total, parTotal, idx };
        })
        .filter(Boolean)
        .sort((a, b) => {
          if (a.total === 0 && b.total === 0) return 0;
          if (a.total === 0) return 1;
          if (b.total === 0) return -1;
          return (a.total - a.parTotal) - (b.total - b.parTotal);
        });

      const standingsList = $("standingsList");
      standingsList.innerHTML = "";
      standings.forEach((p, pos) => {
        const rel = getRelativeScore(p.total, p.parTotal);
        const row = document.createElement("div");
        row.className = "standings-row";
        row.innerHTML = `
          <div class="standings-left">
            <span class="standings-position p${pos + 1}">${pos + 1}</span>
            <span class="standings-name">${p.name}</span>
          </div>
          <div class="standings-right">
            <span class="standings-total">${p.total || "-"}</span>
            <span class="standings-relative ${rel.class}">${p.total ? rel.text : "-"}</span>
          </div>
        `;
        standingsList.appendChild(row);
      });

      renderPastHoles(players, pars, completedHoles);
      startCountdown();
    }

    function renderPastHoles(players, pars, completedHoles) {
      const table = $("pastHolesTable");
      if (completedHoles === 0) { $("pastHolesSection").style.display = "none"; return; }
      $("pastHolesSection").style.display = "block";

      let html = "<thead><tr><th>Player</th>";
      for (let h = 1; h <= completedHoles; h++) html += `<th>${h}</th>`;
      html += "</tr></thead><tbody>";
      html += "<tr><td style='color:var(--text-muted)'>Par</td>";
      for (let h = 0; h < completedHoles; h++) html += `<td>${pars[h]}</td>`;
      html += "</tr>";

      players.forEach((p, idx) => {
        if (!p || !p.id) return;
        const scores = p.scores || [];
        html += `<tr><td>${p.name || "Player " + (idx + 1)}</td>`;
        for (let h = 0; h < completedHoles; h++) {
          const score = scores[h];
          if (score != null) {
            const cls = getScoreClass(score, pars[h]);
            html += `<td><span class="past-hole-score ${cls}">${score}</span></td>`;
          } else {
            html += `<td>-</td>`;
          }
        }
        html += "</tr>";
      });
      html += "</tbody>";
      table.innerHTML = html;
    }

    // ==============================
    // Game actions
    // ==============================
    async function createGame(name, courseId) {
      if (!db || !name) return;
      currentPlayerId = getPlayerId();
      currentPlayerSlot = 0;

      const players = Array(MAX_PLAYERS).fill(null).map(() => ({ id: null, name: "", scores: [] }));
      players[0] = { id: currentPlayerId, name, scores: [] };

      const docRef = await db.collection("games").add({
        courseId,
        startedAt: firebase.firestore.FieldValue.serverTimestamp(),
        players
      });

      currentGameId = docRef.id;
      localStorage.setItem(STORAGE_GAME_ID, currentGameId);
      localStorage.setItem(STORAGE_SLOT, "0");

      subscribeToGame(docRef);
      showGameUI();
      $("inviteCodeValue").textContent = currentGameId;
      openSheet("inviteSheet");
    }

    async function joinGame(name, gameId) {
      if (!db || !name || !gameId) return;
      currentPlayerId = getPlayerId();

      const docRef = db.collection("games").doc(gameId);
      const snap = await docRef.get();
      if (!snap.exists) { showToast("Error", "Game not found. Check the code."); return; }

      const data = snap.data();
      let players = data.players || [];

      let slot = players.findIndex(p => p && p.id === currentPlayerId);
      if (slot === -1) {
        slot = players.findIndex(p => !p || !p.id);
        if (slot === -1) { showToast("Error", "Game is full (4 players max)"); return; }
        players[slot] = { id: currentPlayerId, name, scores: [] };
      } else {
        players[slot].name = name;
      }

      await docRef.update({ players });

      currentGameId = gameId;
      currentPlayerSlot = slot;
      localStorage.setItem(STORAGE_GAME_ID, gameId);
      localStorage.setItem(STORAGE_SLOT, String(slot));

      subscribeToGame(docRef);
      showGameUI();
    }

    async function rejoinGame() {
      const gameId = localStorage.getItem(STORAGE_GAME_ID);
      const slot = parseInt(localStorage.getItem(STORAGE_SLOT) || "0");
      if (!gameId || !db) { showNoGameUI(); return; }

      currentPlayerId = getPlayerId();
      currentGameId = gameId;
      currentPlayerSlot = slot;

      const docRef = db.collection("games").doc(gameId);
      const snap = await docRef.get();
      if (!snap.exists) {
        localStorage.removeItem(STORAGE_GAME_ID);
        localStorage.removeItem(STORAGE_SLOT);
        showNoGameUI();
        return;
      }

      subscribeToGame(docRef);
      showGameUI();
    }

    function subscribeToGame(docRef) {
      if (unsubGame) unsubGame();
      unsubGame = docRef.onSnapshot(snap => {
        if (!snap.exists) { showNoGameUI(); return; }
        renderGame(snap.data());
      });
      subscribeToMessages(currentGameId);
    }

    async function submitScore() {
      if (!currentGameId || currentPlayerSlot == null || selectedScore == null) return;
      const currentHole = getCurrentHole(currentGameData);
      const docRef = db.collection("games").doc(currentGameId);
      const snap = await docRef.get();
      const data = snap.data();
      const players = data.players || [];
      if (!players[currentPlayerSlot]) return;

      const scores = players[currentPlayerSlot].scores || [];
      scores[currentHole - 1] = selectedScore;
      players[currentPlayerSlot].scores = scores;

      await docRef.update({ players });
      if (navigator.vibrate) navigator.vibrate(50);
    }

    // ==============================
    // Chat
    // ==============================
    function subscribeToMessages(gameId) {
      if (!db || !gameId) return;
      if (unsubMessages) unsubMessages();
      messagesInitialized = false;
      const lastSeenTs = parseInt(localStorage.getItem(STORAGE_LAST_SEEN) || "0");

      unsubMessages = db.collection("games").doc(gameId)
        .collection("messages")
        .orderBy("createdAt", "desc")
        .limit(50)
        .onSnapshot(snap => {
          renderChat(snap);

          if (!messagesInitialized) {
            messagesInitialized = true;
            let missedCount = 0;
            snap.forEach(doc => {
              const msg = doc.data();
              if (msg.fromId === currentPlayerId) return;
              let msgTs = 0;
              if (msg.createdAt) {
                msgTs = msg.createdAt.toMillis ? msg.createdAt.toMillis() : (msg.createdAt.seconds * 1000);
              }
              if (msgTs > lastSeenTs) missedCount++;
            });
            if (missedCount > 0 && !$("chatSheet").classList.contains("visible")) {
              updateUnreadBadge(missedCount);
            }
            return;
          }

          snap.docChanges().forEach(change => {
            if (change.type !== "added") return;
            const msg = change.doc.data();
            if (!msg || msg.fromId === currentPlayerId) return;
            if (!$("chatSheet").classList.contains("visible")) {
              incrementUnread();
              showToast(msg.fromName || "Player", msg.text || "", () => openSheet("chatSheet"));
            }
          });
        });
    }

    function renderChat(snap) {
      const thread = $("chatThread");
      const messages = [];
      snap.forEach(doc => {
        const msg = doc.data();
        messages.push({ ...msg, isMine: msg.fromId === currentPlayerId });
      });
      messages.sort((a, b) => {
        const ta = a.createdAt?.toMillis?.() || 0;
        const tb = b.createdAt?.toMillis?.() || 0;
        return ta - tb;
      });

      thread.innerHTML = messages.length === 0
        ? '<div style="text-align:center; color:var(--text-muted); padding:20px; opacity:0.7;">No messages yet. Start the smack talk.</div>'
        : messages.map(m => `
            <div class="chat-message${m.isMine ? " me" : ""}">
              <span class="meta">${m.fromName || "Player"}</span>
              <span class="text">${m.text || ""}</span>
            </div>
          `).join("");
      thread.scrollTop = thread.scrollHeight;
    }

    async function sendMessage() {
      const text = $("chatInput").value.trim();
      if (!text || !currentGameId) return;
      const myPlayer = currentGameData?.players?.[currentPlayerSlot];

      await db.collection("games").doc(currentGameId)
        .collection("messages")
        .add({
          fromId: currentPlayerId,
          fromName: myPlayer?.name || "Player",
          fromSlot: currentPlayerSlot,
          text,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

      $("chatInput").value = "";
      closeSheet("chatSheet");
    }

    function incrementUnread() { updateUnreadBadge(unreadCount + 1); }

    function clearUnread() {
      unreadCount = 0;
      updateUnreadBadge(0);
      localStorage.setItem(STORAGE_LAST_SEEN, String(Date.now()));
    }

    function updateUnreadBadge(count) {
      unreadCount = count;
      const badge = $("chatBadge");
      const fab = $("chatFab");
      if (count > 0) {
        badge.textContent = count > 99 ? "99+" : count;
        badge.classList.add("visible");
        fab.classList.add("has-unread");
      } else {
        badge.classList.remove("visible");
        fab.classList.remove("has-unread");
      }
    }

    // ==============================
    // Analytics
    // ==============================
    function buildAnalytics() {
      const content = $("analyticsContent");
      if (!currentGameData) { content.innerHTML = '<p style="color:var(--text-muted)">No game data yet.</p>'; return; }

      const players = currentGameData.players || [];
      const course = COURSES[currentGameData.courseId] || COURSES["st-andrews"];
      const pars = course.pars;
      const currentHole = getCurrentHole(currentGameData);
      const completedHoles = Math.min(currentHole - 1, HOLES);

      let html = "";
      players.forEach((p, idx) => {
        if (!p || !p.id) return;
        const scores = p.scores || [];
        let total = 0, parTotal = 0;
        for (let h = 0; h < completedHoles; h++) {
          if (scores[h] != null) { total += scores[h]; parTotal += pars[h]; }
        }
        const rel = getRelativeScore(total, parTotal);
        html += `
          <div class="analytics-row">
            <span class="analytics-name">${p.name || "Player " + (idx + 1)}</span>
            <span class="analytics-score">${total || "-"} (${total ? rel.text : "-"})</span>
          </div>
        `;
      });
      content.innerHTML = html || '<p style="color:var(--text-muted)">No players yet.</p>';
    }

    // ==============================
    // Init
    // ==============================
    function init() {
      // Theme
      const savedMode = localStorage.getItem(STORAGE_MODE) || "dark";
      const savedAccent = localStorage.getItem(STORAGE_ACCENT) || "normal";
      body.dataset.mode = savedMode;
      body.dataset.accent = savedAccent;
      $("themeToggle").checked = savedMode === "dark";
      $("accentToggle").checked = savedAccent === "invert";

      renderScoreButtons();
      updateStartButtons();

      // Sheet backdrops
      ["chatSheet", "settingsSheet", "rulesSheet", "analyticsSheet", "createSheet", "joinSheet", "inviteSheet"].forEach(id => {
        setupSheetBackdrop(id, () => closeSheet(id));
      });

      // Start modal
      $("startCreateBtn").onclick = () => { $("startModal").classList.add("hidden"); openSheet("createSheet"); };
      $("startJoinBtn").onclick = () => { $("startModal").classList.add("hidden"); openSheet("joinSheet"); };
      $("startRejoinBtn").onclick = () => rejoinGame();
      $("startRulesBtn").onclick = () => { $("startModal").classList.add("hidden"); openSheet("rulesSheet"); };

      // No game state
      $("noGameCreateBtn").onclick = () => openSheet("createSheet");
      $("noGameJoinBtn").onclick = () => openSheet("joinSheet");

      // Create sheet
      $("createCloseBtn").onclick = () => closeSheet("createSheet");
      $("createCancelBtn").onclick = () => closeSheet("createSheet");
      $("createConfirmBtn").onclick = () => {
        const name = $("createNameInput").value.trim();
        const course = $("createCourseSelect").value;
        if (!name) { showToast("Error", "Please enter your name"); return; }
        closeSheet("createSheet");
        createGame(name, course);
      };

      // Join sheet
      $("joinCloseBtn").onclick = () => closeSheet("joinSheet");
      $("joinCancelBtn").onclick = () => closeSheet("joinSheet");
      $("joinConfirmBtn").onclick = () => {
        const name = $("joinNameInput").value.trim();
        const code = $("joinCodeInput").value.trim();
        if (!name || !code) { showToast("Error", "Please enter your name and game code"); return; }
        closeSheet("joinSheet");
        joinGame(name, code);
      };

      // Invite sheet
      $("inviteCloseBtn").onclick = () => closeSheet("inviteSheet");
      $("inviteDoneBtn").onclick = () => closeSheet("inviteSheet");
      $("inviteCopyBtn").onclick = async () => {
        try { await navigator.clipboard.writeText(currentGameId); showToast("Copied!", "Game code copied to clipboard"); }
        catch (e) { console.error(e); }
      };
      $("inviteShareBtn").onclick = async () => {
        const link = window.location.origin + window.location.pathname + "?game=" + currentGameId;
        if (navigator.share) {
          try { await navigator.share({ title: "Join my Pardle game", text: `Code: ${currentGameId}`, url: link }); }
          catch (e) {}
        } else {
          await navigator.clipboard.writeText(link);
          showToast("Copied!", "Invite link copied");
        }
      };
      $("inviteCodePill").onclick = async () => {
        try {
          await navigator.clipboard.writeText(currentGameId);
          $("inviteCodeValue").textContent = "Copied!";
          setTimeout(() => { $("inviteCodeValue").textContent = currentGameId; }, 1000);
        } catch (e) {}
      };

      // Game ID pill
      $("gameIdPill").onclick = async () => {
        if (!currentGameId) return;
        try {
          await navigator.clipboard.writeText(currentGameId);
          const orig = $("gameIdValue").textContent;
          $("gameIdValue").textContent = "Copied!";
          setTimeout(() => { $("gameIdValue").textContent = orig; }, 1000);
        } catch (e) {}
      };

      // Score submission
      $("submitScoreBtn").onclick = submitScore;

      // Past holes toggle
      $("pastHolesToggle").onclick = () => { $("pastHolesSection").classList.toggle("open"); };

      // Chat
      $("chatFab").onclick = () => { clearUnread(); openSheet("chatSheet"); };
      $("chatCloseBtn").onclick = () => closeSheet("chatSheet");
      $("chatCancelBtn").onclick = () => closeSheet("chatSheet");
      $("chatSendBtn").onclick = sendMessage;

      // Settings
      $("settingsBtn").onclick = () => openSheet("settingsSheet");
      $("settingsCloseBtn").onclick = () => closeSheet("settingsSheet");
      $("themeToggle").onchange = () => {
        const mode = $("themeToggle").checked ? "dark" : "light";
        body.dataset.mode = mode;
        localStorage.setItem(STORAGE_MODE, mode);
      };
      $("accentToggle").onchange = () => {
        const accent = $("accentToggle").checked ? "invert" : "normal";
        body.dataset.accent = accent;
        localStorage.setItem(STORAGE_ACCENT, accent);
      };
      $("settingsRulesBtn").onclick = () => { closeSheet("settingsSheet"); openSheet("rulesSheet"); };

      // Rules
      $("rulesCloseBtn").onclick = () => closeSheet("rulesSheet");

      // Analytics
      $("analyticsBtn").onclick = () => { buildAnalytics(); openSheet("analyticsSheet"); };
      $("analyticsCloseBtn").onclick = () => closeSheet("analyticsSheet");

      // URL game code
      const params = new URLSearchParams(window.location.search);
      const gameParam = params.get("game");
      if (gameParam) {
        $("joinCodeInput").value = gameParam;
        $("startModal").classList.add("hidden");
        openSheet("joinSheet");
      }
    }

    init();
  </script>
</body>
</html>
